<!doctype html>
<html lang="en">
  
  <head>
    <meta charset="utf-8">
    
    <title>node.js training | Four Kitchens</title>

    <meta name="description" content="node.js training slides built with love by the Web Chefs at Four Kitchens.">
    <meta name="author" content="Four Kitchens">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    
    <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='$itext/css'>

    <link rel="favicon" href="favicon.ico">
    
    <link rel="stylesheet" href="css/main.css">

    <link rel="stylesheet" href="css/theme/fourkitchens.css" >

    <!-- For syntax highlighting -->
    <link rel="stylesheet" href="lib/css/github.css">

    <script>
      // If the query includes 'print-pdf' we'll use the PDF print sheet
      document.write( '<link rel="stylesheet" href="css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>
  
  <body>
    
    <div class="reveal">
      <!-- Used to fade in a background when a specific slide state is reached -->
      <div class="state-background"></div>

      <div class="slides">
        <section data-markdown>
          ##Welcome to Drupal & Node.js Training

          <div class="logos">
            <img src="assets/img/druplicon.png" class="logo-drupal no-border"> <img src="assets/img/nodejs.png" class="logo-node no-border">
          </div>

          To test test out the internet visit our class notes google doc and put in your name, your spice and what you want to do with Node and drupal. [http://bit.ly/12ERwzm](http://bit.ly/12ERwzm)
        </section>
        <section data-markdown>
          ## Hello Class
          ```javascript
          console.log('Welcome!');
          ```
          <img src="assets/img/fourkitchens.png" class="no-border">
        </section>
        <section data-markdown>
          ![slides](assets/img/slides.jpg)

          * **[fourkitchens.github.com/train-node](http://fourkitchens.github.com/train-node)**
          * We use [reveal.js](http://lab.hakim.se/reveal-js/)
          * Use ```esc``` to get a top level view of the slides.
          * Feel free to open the slides in a browser locally and use them to copy code.
          * You can see which slide we are on from the number in the lower right.
        </section>
        <section>
          <h2>Who we are</h2>

          <div class="instructor group">
            <img src="http://img.fourkitchens.com/sites/default/files/profiles/avatars/elliott-foster-100.png" />
            <h3>Elliott Foster</h3>
            <ul>
              <li><a href="https://twitter.com/elliotttf">https://twitter.com/elliotttf</a></li>
            </ul>
          </div>

          <div class="instructor group">
            <img src="http://img.fourkitchens.com/sites/default/files/profiles/avatars/mike-100_0.jpg" />
            <h3>Mike Minecki</h3>
            <ul>
              <li><a href="https://twitter.com/mirzu">https://twitter.com/mirzu</a></li>
            </ul>
          </div>
        </section>
        <section data-markdown>
          ## What you'll walk away with

          * Callbacks!
            * You'll know why that's funny
          * A Socket.io app
          * A chance to use the Express Node.js framework.
          * A few strategies on how to work node into your Drupal projects.
        </section>
        <section data-markdown>
          ## What we'll build

          A "real-time" webapp.

          * Pulls nodes from Drupal
          * Has the basis for a chat
          * BONUS: Pulls images from Flickr

        </section>
        <section data-markdown>
          ## What we'll build


          ![block diagram](assets/img/client.png)
        </section>
        <section data-markdown>
          ## Class outline.

          * Intro to node.js
          * Console.log
          * Hello World
          * Integrating with Drupal 1
          * **Lunch**
          * Async programing
          * Using Require() *NPM & Modules*
          * Quick intro to Events
          * Integrating with Drupal 2
          * Socket.io
        </section>
        <section data-markdown>
          ## Frustrated?

          * Who here has been confused, lost, or frustrated?
          * Raise your hand! It's ok to be confused, lost, or frustrated!
          * If you are lost tell us, it's normal and you're not slowing us down.
          * We're here to help and enable!
        </section>
        <section data-markdown>
          ## Shy?

          <ul>
            <li class="fragment">So are we.</li>
            <li class="fragment">We have candy and will give it to you for asking questions.</li>
          </ul>

          ![engineer](assets/img/penguin.jpg)

        </section>
        <section data-markdown>
          ## What is node.js?
        </section>
        <section>
          <small>What is node.js?</small>
          <section data-markdown>
            ## From Nodejs.org

            <blockquote>Node.js is a platform built on Chrome's JavaScript runtime for easily building fast, scalable network applications. Node.js uses an event-driven, non-blocking I/O model that makes it lightweight and efficient, perfect for data-intensive real-time applications that run across distributed devices.
            </blockquote>
          </section>
          <section data-markdown>
            # WAT?
          </section>
          <section data-markdown>
            <blockquote>
              Node.js is a platform built on Chrome's JavaScript runtime [...]
            </blockquote>

            * Chrome's JavaScript runtime is called V8, it's one of the reasons
              Chrome is considered so fast.
            * node.js leverages V8's speed on the server!
          </section>
          <section data-markdown>
            <blockquote>
              [...] easily building fast, scalable network applications.
            </blockquote>

            * Node wants to act as a message passer (more on this later).
          </section>
          <section data-markdown>
            <blockquote>
              Node.js uses an event-driven, non-blocking I/O model [...]
            </blockquote>

            * Only one thing gets executed at a time, but libraries allow I/O
              or other intensive tasks to be executed asynchronously so the
              script doesn't need to wait for them to finish.
          </section>
          <section data-markdown>
            ### What Makes it
            ### *Fast and Scaleable?*

            * V8 Engine

            * Asynchronous libraries

            * Event Driven.
          </section>
          <section data-markdown>
            ## Why do we need another server side language/framework?
          </section>
          <section data-markdown>
            # PHP is slow.
          </section>
          <section data-markdown>
            ## What do you mean by slow?
          </section>
          <section data-markdown>
            ## We actually mean Drupal and we mean it's bad at concurrency.
          </section>
          <section data-markdown>
            ### Why is PHP/Drupal bad at handling concurrency?

            * Big memory foot print.
              * If you need to load 100Meg of Code to deliver 4 lines of JSON. . .
            * Everything happens in order.
              * Your 100ms database call will hold up the execution of the entire process.
              * Your next 100ms call will do the same, etc.
              * Only after all the database calls have completed can we return the 4 lines of JSON.
          </section>
          <section data-markdown>
            ## In node:

            <blockquote>Everything happens in Parellel execpt for your code.</blockquote>
          </section>
          <section data-markdown>
            #huh?
          </section>
          <section data-markdown>
            ## Imagine a King with servants

            * Every morning the servants line up.
            * One at a time they come into his throne room.
            * They report on what they've done.
            * Sometimes the king gives them more to do.
            * Always one at a time, so the king can focus.
          </section>
          <section data-markdown>
            ## Code Please.

            <pre><code class="javascript">
              var fs  = require('fs');
              var sys = require('sys');

              fs.readFile('treasure-chamber-report.txt', function readFile(report) {
                sys.puts("oh, look at all my money: "+report);
              });

              fs.writeFile('letter-to-princess.txt', '...', function writeFile() {
                sys.puts("can't wait to hear back from her!");
              });
            </code></pre>
          </section>
          <section data-markdown>
            ### Explain the Code Please.

            * Code gives node 2 things to do.
            * Each callback gets fired one at a time
            * Until one callback is fired all others wait in line
          </section>
          <section data-markdown>
            ### However

            * We don't need to wait for the file being read, to write the file.
            * Both System IO calls are started independently.
          </section>
          <section data-markdown>
            ### Don't need to wait for one to finish before the next starts!
          </section>
          <section data-markdown>
            ## Why not write non-blocking/event-driven PHP

          </section>
          <section data-markdown>
            ## There are event driven Async PHP frameworks.

            For example: [PRADOTM](http://www.photon-project.com/)
          </section>
          <section data-markdown>
            ## Libraries.

            * PHP libraries are primarily blocking and not event driven.
            * Node.js libraries are almost all non-blocking and event driven.
          </section>
          <section data-markdown>
            ### What is node.js good for

            * Rapid prototyping
            * Bursty load
            * API glue
            * Queue-ish stuff
            * "Real-time" applications
              * Easy example: chat
            * **Message passing!**
          </section>
          <section data-markdown>
            ### What is node.js NOT good for

            * General purpose web server
            * (Large) static assets
            * Complex systems (business logic)
            * Lots of processing - use C or PHP
          </section>
          <section data-markdown>
            ### What We've used it for

            * [RSS Hub](https://github.com/elliotttf/PubHub)
            * [Interactive game](http://drupalpoetry.com)
            * Realtime video commenting
            * [IRC Bot](http://hubot.github.com/)
            * [Parsing HTML](https://github.com/tmpvar/jsdom)
          </section>
          <section data-markdown>
            ### What about the community?

            * Welcoming community
            * Package manager that kicks butt
              * Over 16k packages
            * Very fast moving project
              * 63 Releases in the last year and half
              * BUT has really good test coverage
            * Lots of Frameworks
            * Drupal module
          </section>
          <section data-markdown>
            ## One more thing . . .
          </section>
          <section data-markdown>
            ## Share client and server side code.

            ![yeah](assets/img/glasses-off.gif)
          </section>
        </section>
        <section data-markdown>
          ## Lets get into it!

          ![Adventure Time](assets/img/adventuretime.png)
        </section>
        <section>
          <small>Your environment</small>
          <section data-markdown>
            ## Connecting to the server

            * SSH into the server from your local machine
              <pre><code class="no-highlight">
                $ ssh YOU@nodejs.4kclass.com
              </code></pre>
            * Pro-tip: You may want to keep two terminal sessions open to the server so
              you can edit files while running a node process or edit two files
              at once in different windows.
          </section>
          <section data-markdown>
            ## Editing files

            * Use your preferred editor on server
              (we like vim but won't judge if you use emacs -- but we can't help you either).
            * If you want to edit files locally, SFTP with the credentials you were provided
              <pre><code class="no-highlight">
                $ sftp YOU@nodejs.4kclass.com
              </code></pre>

            * You can also use your preferred SFTP client.
          </section>
          <section data-markdown>
            ## File structure

            * All course code is located in
              <pre><code class="no-highlight">~/nodejs</code></pre>
            * Familiarize yourself with the files and directories here,
              you'll be spending most of your time in the following directories:
              <pre><code class="no-highlight">
                ~/nodejs/js101
                ~/nodejs/exercises/drupal
                ~/nodejs/exercises/server
              </code></pre>
          </section>
          <section data-markdown>
            ## Commands you'll be using

            * ```cp [src] [dst]``` - to copy a file
            * ```mv [src] [dst]``` - to move or rename a file
            * ```rm [file]``` - to delete a file
            * ```node [file]``` - to start a node process (or just ```node``` to
              use the node REPL shell).
            * ```CTRL+C``` - to stop a node process that does not automatically exit.

          </section>
        </section>
        <section data-markdown>
          ## ```console.log()```

          Same debugging tool you use in the browser.

          * Create your first app!
          * Make an app.js file in the _/console.log_ folder.
          * Add one line. . .

          <pre><code class="javascript">
            console.log('Mathamatical!');
          </code></pre>

          Now run it

          <pre><code class="no-highlight">
            $ node app
          </code></pre>
        </section>
        <section data-markdown>
          ![result](assets/img/consolelog.png)
        </section>
        <section data-markdown>
          ## Hello World!
        </section>
        <section>
          <small>Hello world server</small>
          <section data-markdown>
            ## Port Number

            * A unique port has been assigned to each of you, it's in the
              ```~/port-xxxxx``` file in your home directory. You'll need
              this when we start a node server.
            * The ```~/config.json``` file in your home directory can be used to
              inject settings in your node code (more on that later).
          </section>
          <section data-markdown>
            ## Your first Server.

            ```~/nodejs/hello/app.js```

            * Respond to the HTTP request with a hello world message
          </section>
          <section data-markdown>
            <pre><code class="javascript">
              var http = require('http');
              http.createServer(function hello(request, response) {
                res.writeHead(200, {'Content-Type': 'text/plain'});
                res.end('Hello World\n');
              }).listen(1337);
              console.log('Server running at http://127.0.0.1:1337/');
            </code></pre>

            change *1337* to your port number.

          </section>
        </section>
        <section data-markdown>
          #JS101
        </section>
        <section data-markdown>
          ## WAT

          * We've secretly replaced the js101 section with a funny video.
          * Lets see if the class notices.
          * Don't worry we'll dive down into the basics after lunch.
          * For now lets have some fun!
        </section>
        <section data-markdown>
          ## WAT

          [![wat](assets/img/wat.png)](assets/video/wat.mov)
        </section>
        <section>
          <small>A quick intro to Express</small>
          <section data-markdown>
            ### Express

            * A web application framework for node.js
            * Provides:
              * Static asset handling
              * Dynamic router
              * [Connect](http://www.senchalabs.org/connect/) middleware
          </section>
          <section data-markdown>
            ### Getting started

            * Use the ```express``` command to set up some scaffolding for a new application:
            <pre><code class="no-highlight">
              $ cd ~/nodejs/exercies
              $ express myserver
              $ cd myserver
              $ npm install
            </code></pre>
          </section>
          <section data-markdown>
            ### Copy your personal Config file.

            * We're going to make a few changes to support the application we're going to build:
              1. Copy the config.js file and client directory from your home directory to the example dirctory:
                <pre><code class="no-highlight">
                  $ cp ~/config.js ~/nodejs/exercises/myserver/config.js
                </code></pre>
          </section>
          <section data-markdown>
            ## Edit app.js

            Include the config we copied by adding it after the where path is required. Don't forget to remove the ";" after require('path').

            <pre><code class="diff">
-  , path = require('path');
+  , path = require('path')
+  , config = require('./config');
            </code></pre>

            Use the port number from the config file.

            <pre><code class="diff">
-  app.set('port', process.env.PORT || 3000);
+  app.set('port', config.port);
            </code></pre>
          </section>
          <section data-markdown>
            ## Try it.
            ![express works](assets/img/express.png)
          </section>
        </section>
        <section data-markdown>
          ## Integrating with Drupal I
        </section>
        <section>
          <small>Integrating with Drupal I</small>
          <section data-markdown>
            ## What we'll build.

            * We'll ping the node server with with node title
            * We'll create a list of Drupal nodes in our app.

          </section>
          <section data-markdown>
            ### Create the Node.js Endpoint.

            <pre><code class="javascript">
              app.post('/ping', function postPing(request, response){
                console.log(request.body);      // your JSON
                response.send(request.body);    // echo the result back
              });
            </code></pre>
          </section>
          <section data-markdown>
            ### Create a Drupal module to send the title to node.

            1. Stub drupal module is created already.
            2. We'll put the code that talks to node in a node_view hook.
            3. Hint: we'll use drupal\_json\_encode() and drupal\_http\_request()
            4. Be sure to handle errors.
          </section>
          <section data-markdown>
            ### Example Drupal Module code.
            <pre><code class="php">
              $data = array('title' => $node->title);
              $data = drupal_json_encode($data);
              $uri = variable_get('ping_nodejs_uri','http://localhost:3000/ping');

              $options = array();
              $options['headers'] = array('Content-Type' => 'application/json');
              $options['method'] = 'POST';
              $options['data'] = $data;
              $response = drupal_http_request($uri, $options);

              if ($response->code != 200) {
                drupal_set_message("Got an error: " . $response->error, 'error');
              }
              else {
                drupal_set_message('Successfully contacted node server. Response was: ' . $response->data);
              }
            </code></pre>
          </section>
        </section>
        <section data-markdown>
          ## Munch on Lunch

          ![lunch](assets/img/alpaca-lunch.jpg)
        </section>
       <section data-markdown>
         ## Asynchronous programming
       </section>
       <section>
          <small>Asynchronous programming</small>
          <section data-markdown>
            ## How to stop Code-blocking

            ```async/```

            ![log jam](assets/img/log_jam.jpg)
          </section>
          <section data-markdown>
            ## Remember the King with servants?

            * Every morning the servants line up.
            * One at a time they come into his throne room.
            * They report on what they've done.
            * Sometimes the king gives them more to do.
            * Always one at a time, so the king can focus.
          </section>
          <section data-markdown>
            ## Syncrounous example

            Checkout the order of the log messages.

            <pre><code class="javascript">
              console.log("I'm going to read a file synchronously.");

              syncContents = fs.readFileSync(__filename);

              console.log("I'm done reading the file synchronously.");
              console.log('I read ' + syncContents.length + ' characters.');
              console.log("Now I'm ready to do the next thing.");
            </code></pre>
          </section>

          <section data-markdown>
            ## Asynchronous Example

            Now see how the log messages have changed.

            <pre><code class="javascript">
              console.log("I'm going to read a file asynchronously.");
              fs.readFile(__filename, function readFile(err, data) {
                asyncContents = data;
                console.log("I'm done reading the file asynchronously.");
                console.log('I read ' + asyncContents.length + ' characters.');
              });
              console.log("Now I'm ready to do the next thing.");
            </code></pre>
          </section>
          <section data-markdown>
            ## Results

            ![async](assets/img/async.png)
          </section>
          <section data-markdown>
            ## Why have both?
          </section>
          <section data-markdown>
            ## Why have both?

            * Sometimes simplifies code flow.
            * Useful if you _need_ to stop code from executing until the operation is completed.
            * Generally you should ask yourself "Should this be a callback instead."

          </section>
          <section data-markdown>
            ## One last note.
          </section>
          <section data-markdown>
            ### Don't do complicated stuff in the event looop.

            <pre><code class="javascript">
              var start = Date.now();

              setTimeout(function timeout1() {
                console.log('We started execution ' + (Date.now() - start) + 'ms ago.');

                for (var x = 0; x < 3999999999; x++) {}

                console.log('Done with timeout1().');
              }, 1000);

              setTimeout(function timeout2() {
                console.log('We started execution ' + (Date.now() - start) + 'ms ago.');
                console.log('Done with timeout2().');
              }, 2000);
            </code></pre>
          </section>
          <section data-markdown>
            ## Keep it simple.

            Don't put complicated logic in the main event thread.

            * Long sorts/searches.
            * Long Math (fibbonacci sequence).
            * Processing lots of raw data.
          </section>
          <section data-markdown>
            ### How to get around this problem:

            * Fork process
            * Hand off to other program and listen for event.
            * Write C
            * Use a queue
          </section>
        </section>
        <section data-markdown>
          ## Events

          * Lots of node functions emit events.
          * Events are what trigger our callbacks.
          * Eventually you'll write your own.

          [Events Explained.](http://howtonode.org/demystifying-events-in-node)
        </section>
        <section data-markdown>
          ## Using ```require()```, NPM, and modules
        </section>
        <section>
          <small> Using require(), NPM, and modules </small>

          <section data-markdown>
            ## ```require()```

            * Used to include built in libraries, libraries from package manager and local files.

            * Automatically handles dependenies.
          </section>
          <section data-markdown>
            <pre><code class="no-highlight">
              ~/nodejs/require/modules
            </code></pre>

            module_a.js

            <pre><code class="javascript">console.log('this is a');</pre></code>

            module_b.js

            <pre><code class="javascript">console.log(' this is b');</pre></code>

            main.js

            <pre><code class="javascript">
              // Note the relative paths, leaving this off for libraries you
              // define is a common mistake.
              require('./module_a');
              require('./module_b')
            </pre></code>

            ```$ node main.js```

          </section>
          <section data-markdown>
            ### Dependency Handling AKA Package.json

            <pre><code class="javascript">
              {
                "author": "Four Kitchens <shout@fourkitchens.com> (http://fourkitchens.com/)",
                "name": "npmExample",
                "description": "An example from the world famous Four Kitchens Node.js training.",
                "version": "0.0.1",
                "homepage": "http://fourkitchens.com",
                "repository": {
                  "type": "git",
                  "url": "git://github.com/fourkitchens/train-node.git"
                },
                "engines": {
                  "node": "~0.8.8"
                },
                "dependencies": {},
                "devDependencies": {},
                "optionalDependencies": {}
              }
            </code></pre>

            [package.json reference](http://package.json.jit.su/)
          </section>
          <section>
            <h3>NPM</h3>

            <ul>
              <li class='fragment'>Node's Personal Manservant</li>
              <li class='fragment'>Collection of over 16k community built libraries</li>
              <li class='fragment'>Handles installation and dependencies</li>
              <li class='fragment'>Everything from GPIO libraries to a few CMSs</li>
            </ul>
          </section>
          <section data-markdown>
            ## NPM Commands

            * npm install <module> - install module
              * add -g to install at the system level.
            * npm install --save <module> - installs module and adds it to your local package.json file.
            * npm install - installs everything from the local package.json file.
            * npm init - creates an empty package.json file
            * npm search - search for modules

            [NPM help (if --help is too old school for you.)](https://npmjs.org/doc/)
          </section>
          <section data-markdown>
            ## Try it

            <pre><code class="no-highlight">
              $ mkdir ~/nodejs/require/colorsExample
              $ cd ~/nodejs/require/colorsExample
              $ npm init
              $ npm install colors
            </code></pre>

            To add a library to your package.json file at install time add --save:

            <pre><code class="no-highlight">
              npm install --save colors
            </code></pre>
          </section>
          <section data-markdown>
            * Create a file called colorsExample.js in the colorsExample directory
            * Here's an example of using the colors library, give it a try and run
              the script with ```node colorsExample``` when you're done editing.
            <pre><code class="javascript">
              // colorsExample.js
              var colors = require('colors');

              console.log('hello'.green); // outputs green text
            </code></pre>
          </section>
          <section data-markdown>
            ## More fun with colors

            <pre><code>
              console.log('i like cake and pies'.underline.red) // outputs red underlined text
              console.log('inverse the color'.inverse); // inverses the color
              console.log('OMG Rainbows!'.rainbow); // rainbow (ignores spaces)
            </code></pre>
          </section>
          <section data-markdown>
            ## Where does ```require()``` look for files?

            * Core libraries
            * modules in the node_modules directory
            * locally defined modules _if the module is prefixed with a path_
              * Paths can be absolute, but this is highly discouraged, use the relative paths or package your own module.

            [the mystery explained](http://www.bennadel.com/blog/2169-Where-Does-Node-js-And-Require-Look-For-Modules-.htm)
          </section>
        </section>
        <section data-markdown>
          ## Integrating with Drupal II
        </section>
        <section>
          <small>Integrating with Drupal II</small>
          <section data-markdown>
            ## Getting a list of Drupal Nodes.

            1. Install and configure Services modules.
            2. Create and theme a route in our app for drupal to ping.
          </section>
          <section data-markdown>
            ## Install and Configure Services module.

            1. It's already there, just enable it.
            2. go to admin/structure/services
            3. configure a rest server with endpoint "rest".
            4. configure the rest server with the node resource.
          </section>
          <section data-markdown>
            ## Create & theme a route to show a list of nodes.

            1. Create a new  Express middleware
            2. Create an endpoint that uses that middleware
            3. Add a template engine to Express.
            4. Create a template for the page of nodes.
          </section>
          <section data-markdown>
            ## Add a new library

            *npm install --save superagent*
          </section>
          <section data-markdown>
            ## Create the Express middleware AKA route.

            Create file: */routes/nodes.js

            ![superagent](http://visionmedia.github.com/superagent/)
            <pre><code class="javascript">
              var request = require('superagent');

              /**
               * Get Nodes function
               *
               */
              module.exports  = function nodes (url, fn) {
                request.get(url)
                  .end(function gotNodes(res) {
                    if (res.body) {
                      return fn(null, res.body);
                    }
                  });
              };
            </code></pre>
          </section>
          <section data-markdown>
            ## Change to our theme engine.

            [handlebars](https://github.com/donpark/hbs), [hbs handlebars for Expresss](https://github.com/wycats/handlebars.js)

            ```npm install --save hbs```

            #### add the themeing engine to our app.
               <pre><code class="diff">
-  app.set('view engine', 'jade');
+  app.set('view engine', 'html');
+  app.engine('html', require('hbs').__express);
            </code></pre>
          </section>
          <section data-markdown>
            ## Create the layout.

            Renders the page.

            * Create the file ```/views/layout.html```
            * [gist with layout](https://gist.github.com/3982145)

            ![handlebars layout](assets/img/handlebars-layout.png)

          </section>
          <section data-markdown>
            ## Create the template

            Render's the content.

            Create the file ```/views/nodes.html```

            ![handlebars template](assets/img/handlebars-node-template.png)

            [gist with template](https://gist.github.com/3982229)
          </section>
          <section data-markdown>
            ## Add code to the app.

            <pre><code class="javascript">
              app.get('/nodes', function getNodes(req, res, next) {
                nodes('http://instructor.nodejs.4kclass.com/exercises/drupal/rest/node.json', function renderNodes(err, nodes) {
                  console.log(nodes);
                  if (err) return next( err);
                  res.render('nodes', { results: nodes });
                });
              });
            </code></pre>
          </section>
        </section>
        <section data-markdown>
          ## Socket.io
        </section>
        <section>
          <small>Socket.io </small>
          <section data-markdown>
            ### What is Socket.io

            <blockquote>
              Socket.IO aims to make realtime apps possible in every browser and mobile device, blurring the differences between the different transport mechanisms. It's care-free realtime 100% in JavaScript.
            </blockquote>
          </section>
          <section data-markdown>
            #### Server
            <pre><code class="javascript">
              var io = require('socket.io').listen(80);

              io.sockets.on('connection', function onConnection(socket) {
                socket.emit('news', { hello: 'world' });
                socket.on('my other event', function onMyOtherEvent(data) {
                  console.log(data);
                });
              });
            </code></pre>

            #### Client

            <pre><code class="javascript">
              var socket = io.connect('http://localhost');
              socket.on('news', function onNews(data) {
                console.log(data);
                socket.emit('my other event', { my: 'data' });
              });
            </code></pre>
          </section>
          <section data-markdown>
            ### What you'll build

            ![client](assets/img/client.png)

            * A backend to this...
          </section>
          <section data-markdown>
            ![block diagram](assets/img/block-diagram.png)
          </section>
          <section data-markdown>
            ### What you'll build

            * A loop to fill out content in the stories region
            * A [socket.io server](https://github.com/learnboost/socket.io#express-3x).
              The client is currently aware of three entities and two events each...
          </section>
          <section data-markdown>
            ### Story

            * story - contains a title, description, and link.
              <pre><code class="javascript">
                {
                  title: 'Story title',
                  description: 'Story body text',
                  link: 'URL to the story'
                }
              </code></pre>
            * socket.io events:
              * newStories - array of story objects to add to the region.
              * refreshStories - array of story objects to replace what's
                in the region with.
          </section>
          <section data-markdown>
            ### Message

            * message - contains a name, message, and time.
              <pre><code class="javascript">
                {
                  name: 'Message Author',
                  message: 'Message body text!',
                  time: new Date()
                }
              </code></pre>
            * socket.io events:
              * newMessages - array of message objects to add to the region.
              * refreshMessages - array of message objects to replace what's
                in the region with.
          </section>
          <section data-markdown>
            ### Image (bonus)

            * image - contains a picture (URL) and link.
              <pre><code class="javascript">
                {
                  picture: 'URL to the image',
                  link: 'URL to where the image should be linked to'
                }
              </code></pre>
            * socket.io events:
              * newImages - array of image objects to add to the region.
              * refreshImages - array of image objects to replace what's
                in the region with.
          </section>
          <section data-markdown>
            ### Bonus challenges!

            1. Save new stories in memory (a variable) so they are accessible to
               your application.
            1. Save messages in memory.
            1. Serve saved stories and messages to clients when they (re)connect.
            1. Fetch custom stories from RSS feeds, third party APIs, or your Drupal site!
          </section>
          <section data-markdown>
            ### Bonus challenges, cont

            1. Fetch custom images and save them in memory.
            1. Serve custom images to clients when they (re)connect.
            1. Store the stories, messages, and images in either MySQL or MongoDB.
               Use this list to avoid creating duplicate content in case the feed
               re-sends an item or you need to restart your node server.
               * Hint: see the next set of slides for some tips on working with
                 databases in node.
          </section>
        </section>
        <section data-markdown>
          ![get on with it](assets/img/get-on-with-it.jpg)
        </section>
        <section>
          <small>The exercises</small>
          <section data-markdown>
            ### Where's the code?

            <pre><code class="no-highlight">
              ~/nodejs/exercises/server/app.js
            </code></pre>

            * This is where you'll be living for the remainder of the class.
              The code is highly commented.
            * Anything marked with ```TODO``` is a task we're going to guide
              the class through.
            * Anything with ```(bonus)``` is a bonus task that we'll guide you through
              if we get to it, but feel free to tackle these on your own if you
              complete the other tasks.
          </section>
          <section data-markdown>
            ### Create some story content.

            <pre><code class="javascript">
              // Keep a counter.
              var count = 0;
              /**
               * Notifies the client of new stories.
               */
              setInterval(function newStories() {
                // Increment the counter.
                count++;

                // Create some story content to send to the client.
                var newStories = [
                  {
                    title: 'New story ' + count,
                    description: 'New story text for ' + count,
                    link: 'http://fourkitchens.com'
                  }
                ];

                // Broadcast the new stories to all clients.
                io.sockets.emit('newStories', newStories);
              }, config.pollInterval || 10000);
            </code></pre>
          </section>
          <section data-markdown>
            ### Create stories from Drupal

            <pre><code class="javascript">
              /**
               * Notifies the client of new stories.
               */
              setInterval(function newStories() {
                nodes('http://instructor.nodejs.4kclass.com/rest/node.json', function gotNodes(err, nodes) {
                  if (err) { return next(err); }

                  var newStories = [];

                  nodes.forEach(function eachNode(node) {
                    newStories.push({
                      title: node.title,
                      description: node.title + ' (nid: ' + node.nid + ')',
                      link: 'http://instructor.nodejs.4kclass.com/node/' + node.nid
                    });
                  });

                  io.sockets.emit('newStories', newStories);
                });
              });
            </code></pre>
          </section>
          <section data-markdown>
            ### Create stories from Drupal

            * Create new content on your Drupal site, you should see it show
              up on the client the next time the site is polled.
            * Want to make it better? Keep a variable with the nodes you've
              already received and only emit the new ones.
          </section>
          <section data-markdown>
            ### Welcome new clients

            <pre><code class="javascript">
              app.get('/messages', function getMessages(req, res) {
                var messages = [
                  {
                    name: 'Training bot',
                    message: 'Welcome to node.js training!',
                    time: new Date()
                  }
                ];

                res.json(messages);
              });
            </code></pre>
          </section>
          <section data-markdown>
            ### Message chat

            <pre><code class="javascript">
              app.post('/message', function postMessage(req, res) {
                res.writeHead(204);
                res.end();

                var newMessages = [req.body];
                io.sockets.emit('newMessages', newMessages);
              });
            </code></pre>
          </section>
          <section data-markdown>
            ### Message chat

            * Try opening your client site in another browser and start
              sending messages!
            * Want to make it better? Store the new messages so you can
              serve chat history to new clients.
          </section>
        </section>
        <section data-markdown>
          ## Working with Streams
        </section>
        <section>
          <small>Working with streams</small>
          <section data-markdown>
            ### Overview

            * As its name implies, streams are a continuous flow of information that can be diverted or processed as it comes in.
          </section>
          <section data-markdown>
            ### Overview

            * As its name implies, streams are a continuous flow of information that can be diverted or processed as it comes in.
            * This is incredibly efficient, because you don't have to wait until a stream is finished before working with any data that's come in.
          </section>
          <section data-markdown>
            ### Overview

            * As its name implies, streams are a continuous flow of information that can be diverted or processed as it comes in.
            * This is incredibly efficient, because you don't have to wait until a stream is finished before working with any data that's come in.
            * Fundumantal abstraction in node.js I/O.
          </section>
          <section data-markdown>
            ### Overview

            * As its name implies, streams are a continuous flow of information that can be diverted or processed as it comes in.
            * This is incredibly efficient, because you don't have to wait until a stream is finished before working with any data that's come in.
            * Fundumantal abstraction in node.js I/O.
            * Can be readable (reading a file), writeable (HTTP response) or both TCP connection.
          </section>
          <section data-markdown>
            ### Best part is. . .

          </section>
          <section data-markdown>
            ### Best part is. . .

            . . . You are already using them.
          </section>
          <section data-markdown>
            ### First code we wrote used a stream.

            <pre><code class="javascript">
              var http = require('http');
              http.createServer(function hello(request, response) {
                res.writeHead(200, {'Content-Type': 'text/plain'});
                res.end('Hello World\n');
              }).listen(1337);
              console.log('Server running at http://127.0.0.1:1337/');
            </code></pre>
          </section>
         
          <section data-markdown>
            ### Lets give it a shot.

            ```~/nodejs/streams```

            * Read a file from the file system and write it out to the console.
          </section>
          <section data-markdown>
            ### On the stream data event write to console.log.
          </section>
          <section data-markdown>
            <pre><code class="javascript">
              file.on('data', function(chunk){
                console.log(chunk.toString());
              });
            </code></pre>
          </section>
          <section data-markdown>
            ### For comparison lets use readFile instead
          </section>
          <section data-markdown>
            <pre><code class="javascript">
            fs.readFile('index.html', function(err, data) {
              if (err) throw err;
              console.log(data.toString());
            });
            </code></pre>

          </section>
          <section data-markdown>
            ### For comparison lets use readFile instead

            ```fs.readFile(filename, [options], callback)```

            * Reads the contents of the file asyncrounsly.
            * [fs.readFile Docs](http://nodejs.org/api/fs.html#fs_fs_readfile_filename_options_callback)
          </section>
          <section data-markdown>
            ### console.log the file contents using readFile().
          </section>
          <section data-markdown>
            ### Now create an HTTP server using readFile
          </section>
          <section data-markdown>
            <pre><code class="javascript">
              fs.readFile('index.html', function (err, data) {
                if (err) {
                  res.statusCode = 500;
                  res.end(String(err));
                }
                else res.end(data);
              });
            </code></pre>
          </section>
          <section data-markdown>
            ## Pipe

            * Method on streams that allows you to route the data from one stream to another directly
            * Allows for some very powerful and performat opperations.
            * works like the unix pipe '|'

            ```history | grep node```
          </section>
          <section data-markdown>
            ### Server using Pipe.
          </section>
          <section data-markdown>
            <pre><code>
              var file = fs.createReadStream('index.html');
              file.pipe(res);
            </code></pre>
          </section>
          <section data-markdown>
            ### Adding a stream of images from flickr to our little webapp.

            * Helper code to get a feed from flickr and pipe into into a stream.
            ** https://gist.github.com/mirzu/5828095

            * New emitter for images.
            https://gist.github.com/mirzu/5828092
          </section>
        </section>  
        <section data-markdown>
          ## Working with Databases
        </section>
        <section>
          <small>Working with databases</small>
          <section data-markdown>
            ### Overview

            * One of the easiest places to see asynchronous programming:
              1. Application makes call to database and immediately returns to the event loop.
              1. Later, database calls back with results.
            * For the more advanced examples in this class you'll be given the opportunity to work with a database, either MySQL or MongoDB.
          </section>
          <section data-markdown>
            ### MySQL

            * [http://www.mysql.com/](http://www.mysql.com/)
            * Relational database system
            * If you're a Drupal developer you're probably pretty familiar with it, but the libraries we'll be using to interact with it aren't as abstracted as DBTNG.
             * i.e. you'll have to write actual SQL queries ಠ_ಠ
          </section>
          <section data-markdown>
            ### Node.js and MySQL

            * We'll be using the [node-mysql](https://github.com/felixge/node-mysql) library.
            * ```$ npm install mysql@2.0.0-alpha3```
            <pre><code class="javascript">
              var mysql = require('mysql');
              var conn = mysql.createConnection({
                host: 'localhost',
                user: 'you',
                password: 'unsafe'
              });
              conn.connect();

              conn.query('SELECT "Hello world" AS message', function selectResult(err, rows, fields) {
                if (err) {
                  throw err;
                }

                console.log(rows[0].message);
              });
              conn.end();
            </code></pre>
          </section>
          <section data-markdown>
            ### MongoDB

            * [http://www.mongodb.org/](http://www.mongodb.org/)
            * Schemaless document store
            * Documents are stored as BSON which is very similar to JSON and therefore extremely convenient to work with in node.js!
          </section>
          <section data-markdown>
            ### MongoDB Examples

            * There's not a real query language in the same sense as MySQL and since the database is schemaless you can throw whatever you like at it:

              ```$ mongo```
            <pre><code class="javascript">
              db.test.insert({
                title: 'test',
                message: 'Hello world'
              });
              db.test.find({ title: 'test' }).pretty();
              db.test.update(
                { title: 'test' },
                { $set: { message: 'Yo dawg' } }
              );
              db.test.find({ title: 'test' }).pretty();
            </code></pre>
          </section>
          <section data-markdown>
            ### Sub documents

            * One of the most useful parts of MongoDB is the ability to store "sub documents" or objects within a primary document:

            <pre><code class="javascript">
              db.test.update(
                { title: 'test'},
                { $set: {
                  speaker: {
                    name: 'Elliott Foster',
                    occupation: 'Hipster Technologist',
                    interests: [
                      'JavaScript',
                      'beer',
                      'bicycles'
                    ]
                  }
                } }
              );
              db.test.find({ 'speaker.name': 'Elliott Foster' }).pretty();
            </code></pre>
          </section>
          <section data-markdown>
            ![mind blown](assets/img/mind-blown.gif)
          </section>
          <section data-markdown>
            ### Node.js and MongoDB

            * We'll be using the [mongode](https://github.com/milewise/mongode) library to interact with MongoDB
            <pre><code class="javascript">
              var mongode = require('mongode');
              var test = mongode.connect('mongo://127.0.0.1/test');
              var collection = test.collection('test');
              var doc = { title: 'test2', message: 'node and mongo, yay!' };
              collection.insert(doc, {safe:true}, function insertResult(err, objects) {
                if (err) {
                  console.error(err.message);
                  process.exit(1);
                }
                collection.findOne({ title: 'test2' }, function findOneResult(err, document) {
                  if (err) {
                    console.error(err.message);
                    process.exit(1);
                  }
                  console.log(document.message);
                  process.exit(0);
                });
              });
            </code></pre>
          </section>
        </section>
        <section>
          <small>Writing your own events</small>
          <section data-markdown>
            ## Roll your own
            <pre><code class="javascript">
              // basic imports
              var events = require('events');
              var util = require('util');

              function Poll(feed) { this.feed = feed; };
              util.inherits(Poll, events.EventEmitter);

              Poll.prototype.getStories = function(callback) {
                var self = this;

                /**
                 * Assume fetchStories grabs an array of content and
                 * executes this callback on completion.
                 */
                fetchStories(self.feed, function gotStories(err, newStories) {
                  if (!err && newStories.length) {
                    self.emit('fed', null, newStories);
                  }
                });
              };
              exports.Poll = Poll;
            </code></pre>
          </section>
        </section>
        <section>
          <small>JavaScript 101</small>
          <section data-markdown>
            ### Hashes (AKA Objects)

            * A hash is an object, they can contain properties:

            <pre><code class="javacript">
              var awesomeCompany = {
                name: 'Four Kitchens',
                location: 'Austin, TX'
              };

              console.log(awesomeCompany.name + ' is awesome!');
            </code></pre>
          </section>
          <section data-markdown>
            ### Hashes (AKA Objects)

            * They can also contain functions:

            <pre><code class="javascript">
              var awesomeCompany = {
                name: 'Four Kitchens',
                location: 'Austin, TX',
                knowsNode: function() {
                  return true;
                }
              };

              if (awesomeCompany.knowsNode()) {
                console.log(awesomeCompany.name + ' knows node!');
              }
            </code></pre>
          </section>
          
        </section>
        <section data-markdown>
            ### Scope: Local Variable Scope

            <pre><code class="javascript">
              /**
               * This function defines its own 'pet' variable that
               * will not alter the one defined in the global scope.
               */
              var example2 = function() {
                var pet = 'chupacabra';
                console.log("My function's pet is a " + pet);
              };

              console.log('Example 2: My pet is a ' + pet);
              example2();
              console.log('Now my pet is a ' + pet);
            </code></pre>
          </section>
          <section data-markdown>
            ### Scope: Local Variable Scope

            ![result](assets/img/scope2.png)
          </section>
          <section data-markdown>
            ## Anonymous and named functions

            ![spy vs spy](assets/img/spy-vs-spy.png)
          </section>
          <section data-markdown>
            ## Functions in Javascript.

            * Functions are objects.
            * Functions can be passed in as arguments.
            * Refered to as a callback.
          </section>

          <section data-markdown>
            ## Functions


            <pre><code class="javascript">
              var Func = function() {
                console.trace("I'm a function.");
                console.log('==========================');
              };

              setTimeout(Func, 2000);
            </code></pre>

          </section>
          <section data-markdown>
            ## Named functions

            <pre><code class="javascript">
              setTimeout(function named() {
                console.trace("I'm named, somebody loves me.");
                console.log('==========================');
              }, 1000);
            </code></pre>
          </section>
          <section data-markdown>
            ## Anonymous functions

            <pre><code class="javascript">
              setTimeout(function() {
                console.trace("I'm anonymous, see?");
                console.log('==========================');
              }, 1);
            </code></pre>
          </section>
          <section data-markdown>
            ## Use named functions.

            * Makes it easier to find what is wrong in the stack trace
            * Whats a stack trace?
          </section>
          <section data-markdown>
            ## Stack Trace

            * Node outputs a list of which functions were called when your code broke
            * Makes it easier to find out where the error was.
          </section>
          <section data-markdown>
            ## Stack Trace Example.

            * First we'll try using console.trace
            * Second we'll uncomment a real mistake and we'll see how it works.

            ![stacktrace](assets/img/stacktrace.png)
          </section>
        <section data-markdown>
          ### This

          <pre><code class="javascript">
            var unicorn = new Unicorn();
            unicorn.addHorns(1);
          </code></pre>

          ![output](assets/img/this1.png)
        </section>
        <section data-markdown>
          ### Whyyy!?!?
          ![whyyyy](assets/img/this-wat.jpg)
        </section>
        <section data-markdown>
          ### Whyyy!?!?

          * Remember when we said everything's an object?
          * The value of ```this``` changed when we entered the ```countHorns()``` function.
        </section>
        <section data-markdown>
          ### Ok, let's fix it!

          <pre><code class="javascript">
            /**
             * Update the Unicorn prototype to be aware of
             * the scope of 'this'.
             */
            Unicorn.prototype.addHorn = function(horns) {
              // Assign the local variable 'self' to the value of 'this' so we can still
              // access 'this' in other scopes.
              var self = this;
              self.horns = horns;

              setTimeout(function countHorns() {
                if (self.horns > 0) {
                  console.log("I'm a unicorn!");
                }
                else {
                  console.log("I have 0 horns. I must be a horse!");
                }
              }, 1);
            };
          </code></pre>
        </section>
        <section data-markdown>
          ### This (fixed)
          <pre><code class="javascript">
            var unicorn2 = new Unicorn();
            unicorn2.addHorn(2);
          </code></pre>
          ![output](assets/img/this2.png)
        </section>
        <section data-markdown>
          ### Yay!
          ![yay](assets/img/this-yay.jpg)
        </section>
      </div>

      <!-- The navigational controls UI -->
      <aside class="controls">
        <a class="left" href="#">&#x25C4;</a>
        <a class="right" href="#">&#x25BA;</a>
        <span id="current-slide"></span>
        <a class="up" href="#">&#x25B2;</a>
        <a class="down" href="#">&#x25BC;</a>
      </aside>

      <!-- Presentation progress bar -->
      <div class="progress"><span></span></div>
      
    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.min.js"></script>

    <script>
      
      // Full list of configuration options available here:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        
        theme: Reveal.getQueryHash().theme || 'default', // available themes are in /css/theme
        transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/linear(2d)

        // Optional libraries used to extend on reveal.js
        dependencies: [
          { src: 'lib/js/highlight.js', async: true, callback: function() { window.hljs.initHighlightingOnLoad(); } },
          { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'lib/js/showdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'lib/js/data-markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: '/socket.io/socket.io.js', async: true, condition: function() { return window.location.host === 'localhost:1947'; } },
          { src: 'plugin/speakernotes/client.js', async: true, condition: function() { return window.location.host === 'localhost:1947'; } },
        ]
      });

      var currentSlide = document.getElementById('current-slide');
      Reveal.addEventListener('slidechanged', function(data) {
        currentSlide.innerHTML = data.indexh + '/' + data.indexv;
      });
    </script>

  </body>
</html>
